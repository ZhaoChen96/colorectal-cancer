#RNA: 
gene_list_1 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster1.txt",sep = "\t", header=T, row.names=1)
gene_list_2 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster2.txt",sep = "\t", header=T, row.names=1)
gene_list_3 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster3.txt",sep = "\t", header=T, row.names=1)
gene_list_4 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster4.txt",sep = "\t", header=T, row.names=1)
gene_list_5 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster5.txt",sep = "\t", header=T, row.names=1)
gene_list_6 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster6.txt",sep = "\t", header=T, row.names=1)
gene_list_7 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster7.txt",sep = "\t", header=T, row.names=1)
gene_list_8 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster8.txt",sep = "\t", header=T, row.names=1)
gene_list_9 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_gene_list_cluster9.txt",sep = "\t", header=T, row.names=1)

#H3K27me3
gene_list_H3K27me3_1 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_1_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_2 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_2_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_3 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_3_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_4 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_4_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_5 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_5_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_6 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_6_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_7 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_7_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_8 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_8_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K27me3_9 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K27me3/H3K27me3_9_gene_list.txt",sep = "\t", header=T, row.names=1)

#heterochromatin
gene_list_heterochromatin_1 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_1_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_2 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_2_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_3 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_3_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_4 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_4_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_5 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_5_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_6 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_6_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_7 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_7_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_8 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_8_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_heterochromatin_9 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/heterochromatin/heterochromatin_9_gene_list.txt",sep = "\t", header=T, row.names=1)

#enhancer
gene_list_enhancer_1 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_1_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_2 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_2_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_3 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_3_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_4 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_4_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_5 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_5_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_6 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_6_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_7 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_7_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_8 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_8_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_enhancer_9 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/enhancer/enhancer_9_gene_list.txt",sep = "\t", header=T, row.names=1)

#H3K4me3
gene_list_H3K4me3_1 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_1_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_2 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_2_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_3 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_3_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_4 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_4_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_5 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_5_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_6 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_6_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_7 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_7_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_8 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_8_gene_list.txt",sep = "\t", header=T, row.names=1)
gene_list_H3K4me3_9 = read.delim("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/chip_v2/H3K4me3/H3K4me3_9_gene_list.txt",sep = "\t", header=T, row.names=1)
rna <- c(gene_list_1,gene_list_2,gene_list_3,gene_list_4,gene_list_5,gene_list_6,gene_list_7,gene_list_8,gene_list_9)

H3K27 <- c(gene_list_H3K27me3_1,gene_list_H3K27me3_2,gene_list_H3K27me3_3,gene_list_H3K27me3_4,gene_list_H3K27me3_5,gene_list_H3K27me3_6,gene_list_H3K27me3_7,gene_list_H3K27me3_8,gene_list_H3K27me3_9)

enhancer <- c(gene_list_enhancer_1,gene_list_enhancer_2,gene_list_enhancer_3,gene_list_enhancer_4,gene_list_enhancer_5,gene_list_enhancer_6,gene_list_enhancer_7,gene_list_enhancer_8,gene_list_enhancer_9)

heter <- c(gene_list_heterochromatin_1,gene_list_heterochromatin_2,gene_list_heterochromatin_3,gene_list_heterochromatin_4,gene_list_heterochromatin_5,gene_list_heterochromatin_6,gene_list_heterochromatin_7,gene_list_heterochromatin_8,gene_list_heterochromatin_9)

H3K4 <- c(gene_list_H3K4me3_1,gene_list_H3K4me3_2,gene_list_H3K4me3_3,gene_list_H3K4me3_4,gene_list_H3K4me3_5,gene_list_H3K4me3_6,gene_list_H3K4me3_7,gene_list_H3K4me3_8,gene_list_H3K4me3_9)

#h3k27
H3K27_df =data.frame(gene_list_H3K27me3_1=0,gene_list_H3K27me3_2=0,gene_list_H3K27me3_3=0,gene_list_H3K27me3_4=0,gene_list_H3K27me3_5=0,gene_list_H3K27me3_6=0,gene_list_H3K27me3_7=0,gene_list_H3K27me3_8=0,gene_list_H3K27me3_9=0)

h3k27 <- purrr::map(1:9,function(a){
           purrr::map(1:9,function(b){bb = H3K27[b]$symbol
                                      aa = rna[a]$symbol
                                      share = length(intersect(aa, bb))
                                      x = c(share, length(aa), 
                                            20000 - length(aa), length(bb))
                                      pValue = phyper(share, length(aa), 
                                                      20000 - length(aa), 
                                                      length(bb), lower.tail = F)
                                      
                                      return(pValue)
                                      })
                                    })

H3K27_p <- data.frame(do.call(rbind,lapply(h3k27, unlist)))
colnames(H3K27_p) <- c("H3K27me3_1","H3K27me3_2","H3K27me3_3","H3K27me3_4","H3K27me3_5","H3K27me3_6","H3K27me3_7","H3K27me3_8","H3K27me3_9")

#enhancer
enhancer_df =data.frame(gene_list_enhancer_1 =0,gene_list_enhancer_2=0,gene_list_enhancer_3=0,gene_list_enhancer_4=0,gene_list_enhancer_5=0,gene_list_enhancer_6=0,gene_list_enhancer_7=0,gene_list_enhancer_8=0,gene_list_enhancer_9=0)
Enhancer <- purrr::map(1:9,function(a){
  purrr::map(1:9,function(b){bb = enhancer[b]$symbol
  aa = rna[a]$symbol
  share = length(intersect(aa, bb))
  x = c(share, length(aa), 
        20000 - length(aa), length(bb))
  pValue = phyper(share, length(aa), 
                  20000 - length(aa), 
                  length(bb), lower.tail = F)
  
  return(pValue)
  })
})

enhancer_p <- data.frame(do.call(rbind,lapply(Enhancer, unlist)))
colnames(enhancer_p) <- c("enhancer_1","enhancer_2","enhancer_3","enhancer_4","enhancer_5","enhancer_6","enhancer_7","enhancer_8","enhancer_9")
#heterochromatin
heterochromatin_df =data.frame(gene_list_heterochromatin_1 =0,gene_list_heterochromatin_2=0,gene_list_heterochromatin_3=0,gene_list_heterochromatin_4=0,gene_list_heterochromatin_5=0,gene_list_heterochromatin_6=0,gene_list_heterochromatin_7=0,gene_list_heterochromatin_8=0,gene_list_heterochromatin_9=0)
Heterochromatin <- purrr::map(1:9,function(a){
                    purrr::map(1:9,function(b){
                      bb = heter[b]$symbol
                      aa = rna[a]$symbol
                      share = length(intersect(aa, bb))
                      x = c(share, length(aa), 
                            20000 - length(aa), length(bb))
                      pValue = phyper(share, length(aa), 
                                      20000 - length(aa), 
                                      length(bb), lower.tail = F)
                      
                      return(pValue)
                      })
                    })

heterochromatin_p <- data.frame(do.call(rbind,lapply(Heterochromatin, unlist)))
colnames(heterochromatin_p)<-c("heterochromatin_1","heterochromatin_2","heterochromatin_3","heterochromatin_4","heterochromatin_5","heterochromatin_6","heterochromatin_7","heterochromatin_8","heterochromatin_9") 

#h3k4
H3K4_df =data.frame(gene_list_H3K4me3_1 =0,gene_list_H3K4me3_2=0,gene_list_H3K4me3_3=0,gene_list_H3K4me3_4=0,gene_list_H3K4me3_5=0,gene_list_H3K4me3_6=0,gene_list_H3K4me3_7=0,gene_list_H3K4me3_8=0,gene_list_H3K4me3_9=0)
h3k4 <- purrr::map(1:9,function(a){
  purrr::map(1:9,function(b){bb = H3K4[b]$symbol
                             aa = rna[a]$symbol
                             share = length(intersect(aa, bb))
                             x = c(share, length(aa), 
                                  20000 - length(aa), length(bb))
                             pValue = phyper(share, length(aa), 
                                             20000 - length(aa), 
                             length(bb), lower.tail = F)
                             
                             return(pValue)
                             })
                          })

H3K4_p <- data.frame(do.call(rbind,lapply(h3k4, unlist)))
colnames(H3K4_p) <- c("H3K4me3_1","H3K4me3_2","H3K4me3_3","H3K4me3_4","H3K4me3_5","H3K4me3_6","H3K4me3_7","H3K4me3_8","H3K4me3_9")

df <- cbind(H3K27_p,enhancer_p,heterochromatin_p,H3K4_p)
rownames(df) <- c("rna_cluster1","rna_cluster2","rna_cluster3","rna_cluster4","rna_cluster5","rna_cluster6","rna_cluster7","rna_cluster8","rna_cluster9")

mydata <- df[c(1,3:9),]
data_final = -log10(mydata)
data_final[data_final > 5] = 5
#pheatmap(as.matrix(data_final), color = colorRampPalette(c("white", "firebrick3"))(100))
# 构建列注释信息
annotation_col = data.frame(
  dd = factor(c(rep("H3K27me3",9),rep("enhancer",9),rep("heterochromatin",9),rep("H3K4me3",9))))
rownames(annotation_col) = colnames(mydata)
head(annotation_col)
data_final = -log10(mydata)
data_final[data_final > 5] = 5
pdf("/home/zhihl/Project/CRC/Chip_analysis/MaSigPro/rna/rna_chip_heatmap.pdf", width = 10, height = 7)
pheatmap(as.matrix(data_final), cellwidth = 12, cellheight = 15,geom = 'circle',color = colorRampPalette(c("white", "firebrick3"))(100),
         annotation_col = annotation_col,
         cluster_col = FALSE,annotation_colors = list(dd = c(H3K27me3="#D19F9F", enhancer="#574142",heterochromatin="#D2B48C", H3K4me3="#58BABA")))
dev.off()
